name: Visual Regression Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.tsx'
      - 'src/**/*.css'
      - 'tailwind.config.js'

permissions:
  contents: write

jobs:
  visual:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright
        run: npx playwright install chromium --with-deps
        
      - name: Run visual tests
        id: visual-test
        run: |
          npx playwright test --project='Desktop Chrome' 2>&1 | tee test-output.log
          exit ${PIPESTATUS[0]}
        continue-on-error: true
        
      - name: Check if snapshots are missing
        id: check-snapshots
        if: steps.visual-test.outcome == 'failure'
        run: |
          HAS_MISSING=false
          HAS_REGRESSIONS=false
          
          # Check if there are missing snapshots
          if grep -qi "snapshot doesn't exist" test-output.log 2>/dev/null; then
            HAS_MISSING=true
          fi
          
          # Check if there are actual visual diffs (regressions)
          if grep -qi "Screenshot comparison failed" test-output.log 2>/dev/null || \
             grep -qi "pixels.*different" test-output.log 2>/dev/null; then
            HAS_REGRESSIONS=true
          fi
          
          echo "missing=$HAS_MISSING" >> $GITHUB_OUTPUT
          echo "has_regressions=$HAS_REGRESSIONS" >> $GITHUB_OUTPUT
        
      - name: Update missing snapshots
        if: steps.check-snapshots.outputs.missing == 'true'
        run: npx playwright test --project='Desktop Chrome' --update-snapshots
        
      - name: Commit updated snapshots
        if: steps.check-snapshots.outputs.missing == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add e2e/layout.spec.ts-snapshots/
          if git diff --staged --quiet; then
            echo "No new snapshots to commit"
          else
            git commit -m "chore: add missing visual regression snapshots (Linux)"
            git pull --rebase origin ${{ github.head_ref }}
            git push origin HEAD:${{ github.head_ref }}
          fi

        
      - uses: actions/upload-artifact@v4
        if: steps.check-snapshots.outputs.missing == 'true'
        with:
          name: playwright-snapshots-linux
          path: e2e/layout.spec.ts-snapshots/
          retention-days: 30
          
      - uses: actions/upload-artifact@v4
        if: steps.check-snapshots.outputs.has_regressions == 'true'
        with:
          name: visual-regression-report
          path: playwright-report/
          
      - name: Fail if visual regression detected
        if: steps.check-snapshots.outputs.has_regressions == 'true'
        run: |
          echo "‚ùå Visual regression detected! Check the uploaded report for details."
          exit 1

